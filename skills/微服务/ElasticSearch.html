<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ElasticSearch | 琅玕的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="个人编程技术分享">
    
    <link rel="preload" href="/blog/assets/css/0.styles.671fbdd0.css" as="style"><link rel="preload" href="/blog/assets/js/app.e95f8842.js" as="script"><link rel="preload" href="/blog/assets/js/3.08356745.js" as="script"><link rel="preload" href="/blog/assets/js/2.9988781b.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.acf34bf9.js"><link rel="prefetch" href="/blog/assets/js/11.fef1fa27.js"><link rel="prefetch" href="/blog/assets/js/12.c774ebf1.js"><link rel="prefetch" href="/blog/assets/js/13.bf6af2da.js"><link rel="prefetch" href="/blog/assets/js/14.7b60b543.js"><link rel="prefetch" href="/blog/assets/js/15.5515032c.js"><link rel="prefetch" href="/blog/assets/js/16.3c0cd04c.js"><link rel="prefetch" href="/blog/assets/js/17.80206c1e.js"><link rel="prefetch" href="/blog/assets/js/18.e5e2c85c.js"><link rel="prefetch" href="/blog/assets/js/19.2f69b079.js"><link rel="prefetch" href="/blog/assets/js/20.7a923a3b.js"><link rel="prefetch" href="/blog/assets/js/21.d81d0001.js"><link rel="prefetch" href="/blog/assets/js/22.2fe5ab39.js"><link rel="prefetch" href="/blog/assets/js/23.99bc8ff5.js"><link rel="prefetch" href="/blog/assets/js/24.1fcf63f7.js"><link rel="prefetch" href="/blog/assets/js/25.a5536fa6.js"><link rel="prefetch" href="/blog/assets/js/26.e2fb222c.js"><link rel="prefetch" href="/blog/assets/js/27.03389df0.js"><link rel="prefetch" href="/blog/assets/js/28.4b72525f.js"><link rel="prefetch" href="/blog/assets/js/29.03a090ad.js"><link rel="prefetch" href="/blog/assets/js/30.87f31b47.js"><link rel="prefetch" href="/blog/assets/js/31.c639ea6f.js"><link rel="prefetch" href="/blog/assets/js/32.795ca246.js"><link rel="prefetch" href="/blog/assets/js/33.647699a4.js"><link rel="prefetch" href="/blog/assets/js/34.2909ac9c.js"><link rel="prefetch" href="/blog/assets/js/35.b5d4b577.js"><link rel="prefetch" href="/blog/assets/js/36.474a6bcb.js"><link rel="prefetch" href="/blog/assets/js/37.4590b450.js"><link rel="prefetch" href="/blog/assets/js/38.1cfbe263.js"><link rel="prefetch" href="/blog/assets/js/39.4c159456.js"><link rel="prefetch" href="/blog/assets/js/4.1c4b8134.js"><link rel="prefetch" href="/blog/assets/js/40.c52cb9af.js"><link rel="prefetch" href="/blog/assets/js/41.f77d6a1f.js"><link rel="prefetch" href="/blog/assets/js/42.c45631ae.js"><link rel="prefetch" href="/blog/assets/js/43.44644811.js"><link rel="prefetch" href="/blog/assets/js/44.c40d24aa.js"><link rel="prefetch" href="/blog/assets/js/45.0c1b86d7.js"><link rel="prefetch" href="/blog/assets/js/46.85dd5346.js"><link rel="prefetch" href="/blog/assets/js/47.a52d8379.js"><link rel="prefetch" href="/blog/assets/js/48.dfaedde6.js"><link rel="prefetch" href="/blog/assets/js/49.604893e5.js"><link rel="prefetch" href="/blog/assets/js/5.b41d7dd5.js"><link rel="prefetch" href="/blog/assets/js/50.228c7e1a.js"><link rel="prefetch" href="/blog/assets/js/51.7a95ac4e.js"><link rel="prefetch" href="/blog/assets/js/52.79ff7d2e.js"><link rel="prefetch" href="/blog/assets/js/53.7aeffa50.js"><link rel="prefetch" href="/blog/assets/js/54.c7097067.js"><link rel="prefetch" href="/blog/assets/js/6.31dc016b.js"><link rel="prefetch" href="/blog/assets/js/7.96c397d1.js"><link rel="prefetch" href="/blog/assets/js/8.e97d6841.js"><link rel="prefetch" href="/blog/assets/js/9.66ed6f07.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.671fbdd0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">琅玕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  资源分享
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  资源分享
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/skills/IoT" class="sidebar-heading clickable"><span>IoT</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/IoT/基于NodeMcu的智慧生态农业系统设计.html" class="sidebar-link">基于NodeMcu的智慧生态农业系统设计</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/JavaSE" class="sidebar-heading clickable"><span>JavaSE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/JavaSE/File类和IO流.html" class="sidebar-link">File类和IO流</a></li><li><a href="/blog/skills/JavaSE/Java基础手写笔记.html" class="sidebar-link">/skills/JavaSE/Java基础手写笔记.html</a></li><li><a href="/blog/skills/JavaSE/Java常用API.html" class="sidebar-link">Java常用API</a></li><li><a href="/blog/skills/JavaSE/Thread.html" class="sidebar-link">Thread</a></li><li><a href="/blog/skills/JavaSE/内部类.html" class="sidebar-link">内部类</a></li><li><a href="/blog/skills/JavaSE/反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/DSDB" class="sidebar-heading clickable"><span>DSDB</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/DSDB/Collection.html" class="sidebar-link">Java的集合类</a></li><li><a href="/blog/skills/DSDB/HTTP&amp;Tomcat.html" class="sidebar-link">HTTP&amp;Tomcat</a></li><li><a href="/blog/skills/DSDB/JDBC.html" class="sidebar-link">JDBC</a></li><li><a href="/blog/skills/DSDB/Map.html" class="sidebar-link">Map</a></li><li><a href="/blog/skills/DSDB/Maven.html" class="sidebar-link">Maven</a></li><li><a href="/blog/skills/DSDB/Mybatis.html" class="sidebar-link">Mybatis</a></li><li><a href="/blog/skills/DSDB/SQL.html" class="sidebar-link">SQL</a></li><li><a href="/blog/skills/DSDB/Stream.html" class="sidebar-link">Stream</a></li><li><a href="/blog/skills/DSDB/前端.html" class="sidebar-link">前端</a></li><li><a href="/blog/skills/DSDB/数据库索引.html" class="sidebar-link">数据库索引</a></li><li><a href="/blog/skills/DSDB/连接池.html" class="sidebar-link">/skills/DSDB/连接池.html</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/JavaEE&amp;Spring" class="sidebar-heading clickable"><span>JavaEE&amp;Spring</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/JavaEE&amp;Spring/MyBatis-Spring.html" class="sidebar-link">MyBatis - Spring、Spring事务</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/Request&amp;Response.html" class="sidebar-link">Request &amp; Response</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/Servlet.html" class="sidebar-link">Servlet</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringAOP.html" class="sidebar-link">Spring AOP</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringBoot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringIOC.html" class="sidebar-link">Spring IOC</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringMVC.html" class="sidebar-link">Spring MVC</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/设计模式.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/微服务" class="sidebar-heading clickable open"><span>微服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/微服务/ElasticSearch.html" class="active sidebar-link">ElasticSearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#倒排索引" class="sidebar-link">倒排索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#正排" class="sidebar-link">正排</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#倒排" class="sidebar-link">倒排</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#elasticsearch环境搭建" class="sidebar-link">ElasticSearch环境搭建</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#kibana环境搭建" class="sidebar-link">kibana环境搭建</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#restful-api操作es-使用http" class="sidebar-link">RESTful API操作ES(使用Http)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#操作索引" class="sidebar-link">操作索引</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#操作映射" class="sidebar-link">操作映射</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#操作文档" class="sidebar-link">操作文档</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#java操作es" class="sidebar-link">Java操作ES</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#索引操作" class="sidebar-link">索引操作</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#文档操作" class="sidebar-link">文档操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#elasticsearch的高级操作" class="sidebar-link">ElasticSearch的高级操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#批量操作" class="sidebar-link">批量操作</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#高级查询" class="sidebar-link">高级查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#elasticsearch集群" class="sidebar-link">ElasticSearch集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#文档数据在es集群中的存储和搜索" class="sidebar-link">文档数据在ES集群中的存储和搜索</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#脑裂问题" class="sidebar-link">脑裂问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#elasticsearch应用" class="sidebar-link">ElasticSearch应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#添加、删除文档" class="sidebar-link">添加、删除文档</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#查询" class="sidebar-link">查询</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#构建聚合查询" class="sidebar-link">构建聚合查询</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/ElasticSearch.html#incrhotscore" class="sidebar-link">incrHotScore</a></li></ul></li></ul></li><li><a href="/blog/skills/微服务/Gateway.html" class="sidebar-link">Gateway</a></li><li><a href="/blog/skills/微服务/MapStruct.html" class="sidebar-link">MapStruct</a></li><li><a href="/blog/skills/微服务/Mybatis-Plus.html" class="sidebar-link">Mybatis-Plus</a></li><li><a href="/blog/skills/微服务/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/blog/skills/微服务/Redis.html" class="sidebar-link">Redis</a></li><li><a href="/blog/skills/微服务/Redis在Java项目中的使用.html" class="sidebar-link">Redis在Java项目中的使用</a></li><li><a href="/blog/skills/微服务/RocketMQ.html" class="sidebar-link">RocketMQ</a></li><li><a href="/blog/skills/微服务/SpringCloud.html" class="sidebar-link">SpringCloud</a></li><li><a href="/blog/skills/微服务/微服务.html" class="sidebar-link">微服务</a></li><li><a href="/blog/skills/微服务/微服务架构和单体架构.html" class="sidebar-link">微服务架构和单体架构</a></li><li><a href="/blog/skills/微服务/秒杀.html" class="sidebar-link">秒杀</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/面试" class="sidebar-heading clickable"><span>面试</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/面试/面经.html" class="sidebar-link">面经</a></li><li><a href="/blog/skills/面试/面试准备.html" class="sidebar-link">面试准备</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="elasticsearch"><a href="#elasticsearch" class="header-anchor">#</a> ElasticSearch</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>官方文档：https://www.elastic.co/guide/cn/elasticsearch/guide/current/intro.html</p> <p><img src="/blog/assets/img/image-20231015131823928.12c08187.png" alt="image-20231015131823928"></p> <p>Elastic Saerch是一个分布式全文搜索引擎，是一种文档数据库。</p> <p>它和关系型数据库一样需要存储一条条记录(数据)，与关系型数据库不同的地方是<strong>索引</strong><a href="**%E7%B4%A2%E5%BC%95**(%E4%B8%8A%E9%9D%A2%E7%9A%84%E7%B4%A2%E5%BC%95%E6%8C%87%E7%9A%84%E6%98%AF%E7%94%A8%E4%BA%8E%E5%BF%AB%E9%80%9F%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E4%B8%8E%E4%B8%8B%E9%9D%A2%E6%89%80%E8%AF%B4%E7%9A%84%E7%B4%A2%E5%BC%95%E4%B8%8D%E5%90%8C)">^1</a>组织的方式和查询记录的方式。elasticsearch使用倒排索引来查询数据。</p> <p>ElasticSearch基于C/S架构，默认端口号9200，它的操作都是使用http请求完成。</p> <h2 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h2> <p>elasticSearch是一种文档数据库</p> <ul><li>字段(Field)：类似于关系型数据库中的字段</li> <li>文档(document)：类似于关系型数据库中的一行记录</li> <li>映射(mapping)：类似于关系型数据库中的表结构定义</li> <li>索引(index)：类似于关系型数据库中的数据库概念</li> <li>类型(Type)：类似于关系型数据库中的表</li></ul> <h2 id="倒排索引"><a href="#倒排索引" class="header-anchor">#</a> 倒排索引</h2> <p>此处所说的索引是用于快速访问数据的数据结构</p> <h3 id="正排"><a href="#正排" class="header-anchor">#</a> 正排</h3> <p>根据document找它包含的关键词</p> <h3 id="倒排"><a href="#倒排" class="header-anchor">#</a> 倒排</h3> <p>根据关键字找包含这个关键词的document。</p> <p><strong>添加索引</strong>：数据(document)在添加时，会针对字符串类型的字段创建索引。具体的方式是，将字符串类型的字段进行<strong>分词</strong>，然后以这些分出来的关键词为key，value部分存储包含这个关键词的document的id。</p> <p><strong>根据索引查询记录(搜索)</strong>：</p> <h2 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h2> <p><strong>字符串</strong>：text(会分词，不支持聚合)、keyword(不会分词，将全部内容作为一个词条，支持聚合)</p> <p><strong>数值</strong>：long、integer、short、byte、double、float、half_float、scaled_float</p> <p><strong>布尔</strong>：boolean</p> <p><strong>二进制</strong>：binary</p> <p><strong>范围类型</strong>：integer_range、float_range、long_range、double_range、date_range</p> <p><strong>日期</strong>：date</p> <p><strong>数组</strong>：[]</p> <p><strong>对象</strong>：{}</p> <h2 id="elasticsearch环境搭建"><a href="#elasticsearch环境搭建" class="header-anchor">#</a> ElasticSearch环境搭建</h2> <p>在Linux的docker容器中部署ealsticsearch</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 拉取镜像</span>
<span class="token function">docker</span> pull elasticsearch:7.8.0
<span class="token comment"># 注意如果是ARM架构的计算机，那么下载的ES镜像的版本如下：</span>
<span class="token function">docker</span> pull elasticsearch:7.13.1
<span class="token comment"># 准备工作</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/plugins /mydata/elasticsearch/data
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /mydata/elasticsearch
<span class="token comment"># 运行容器</span>
<span class="token function">docker</span> run <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> elasticsearch <span class="token punctuation">\</span>
<span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token string">&quot;discovery.type=single-node&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms256m -Xmx256m&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/plugins/:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/data/:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> elasticsearch:7.8.0
<span class="token comment"># 注意，ARM架构的计算机，使用的镜像版本为elasticsearch:7.13.1</span>
<span class="token comment"># 测试验证，访问http://ip:9200</span>
</code></pre></div><p>部署成功后</p> <p><img src="/blog/assets/img/image-20231015111831900.94252de0.png" alt="image-20231015111831900"></p> <p>将分词器放入/opt/es目录下</p> <p>先在/opt目录下创建一个es目录，并将它的权限修改为777(可读、可写、可执行)</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /opt
<span class="token function">sudo</span> <span class="token function">mkdir</span> es
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> es
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 1. 上传资料中的IK分词器压缩包到Linux主机/opt/es目录下</span>
<span class="token comment"># 2. 解压</span>
<span class="token function">unzip</span> elasticsearch-analysis-ik-7.8.0.zip <span class="token parameter variable">-d</span> ik-analyzer
<span class="token comment"># 注意如果是ARM架构的计算机，那么使用的ik分词器的版本也要是7.13.1，所以命令如下：</span>
<span class="token function">unzip</span> elasticsearch-analysis-ik-7.13.1.zip <span class="token parameter variable">-d</span> ik-analyzer
<span class="token comment"># 3. 上传到ES容器</span>
<span class="token function">docker</span> <span class="token function">cp</span> ./ik-analyzer elasticsearch:/usr/share/elasticsearch/plugins
<span class="token comment"># 4. 重启ES</span>
<span class="token function">docker</span> restart elasticsearch
</code></pre></div><h2 id="kibana环境搭建"><a href="#kibana环境搭建" class="header-anchor">#</a> kibana环境搭建</h2> <p>kibana相当于ealsticsearch的客户端</p> <p><img src="/blog/assets/img/image-20231014175513254.29e62ecf.png" alt="image-20231014175513254"></p> <p><img src="/blog/assets/img/image-20231015114723626.3b978b97.png" alt="image-20231015114723626"></p> <p>在Linux的docker容器中部署kibana</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 拉取镜像</span>
<span class="token function">docker</span> pull kibana:7.8.0
<span class="token comment"># 注意如果计算机为ARM架构，如果使用的ES版本为7.13.1那么，Kibaba的版本也要相应使用7.13.1</span>
<span class="token function">docker</span> pull kibana:7.13.1

<span class="token comment"># 运行容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_URL</span><span class="token operator">=</span>http://虚拟机ip或者云服务器ip:9200 <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token parameter variable">-d</span> kibana:7.8.0
<span class="token comment"># 举例</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_URL</span><span class="token operator">=</span>http://192.168.140.134/:9200 <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token parameter variable">-d</span> kibana:7.8.0

<span class="token comment"># ARM架构的计算机，使用如下命令</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_URL</span><span class="token operator">=</span>http://虚拟机ip或者云服务器ip:9200 <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token parameter variable">-d</span> kibana:7.13.1

<span class="token comment"># 修改配置</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> kibana /bin/bash
<span class="token function">vi</span> config/kibana.yml
elasticsearch.hosts: <span class="token punctuation">[</span> <span class="token string">&quot;http://这里改为你自己的虚拟机IP:9200&quot;</span> <span class="token punctuation">]</span>

<span class="token comment"># 保存退出并且 重启kibana</span>
<span class="token function">docker</span> restart kibana

<span class="token comment"># 测试验证，访问http://ip:5601</span>
<span class="token comment"># 测试IK分词器</span>
GET /_analyze
<span class="token punctuation">{</span>
	<span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Elasticsearch 是一个开源的搜索引擎，建立在一个全文搜索引擎库 Apache Lucene™ 基础之上。&quot;</span>,
	<span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="restful-api操作es-使用http"><a href="#restful-api操作es-使用http" class="header-anchor">#</a> RESTful API操作ES(使用Http)</h2> <p>以下操作都是在kibana客户端中完成，kibana中配置了elasticsearch服务端的ip和端口号，因此在kibana中可以省略请求中的ip和端口号。</p> <p>以创建索引为例</p> <p>原始的请求为：</p> <div class="language- extra-class"><pre class="language-text"><code>PUT http://ip:端口号/索引名称
</code></pre></div><p>在kibana中请求为：</p> <div class="language- extra-class"><pre class="language-text"><code>PUT 索引名称
</code></pre></div><h3 id="操作索引"><a href="#操作索引" class="header-anchor">#</a> 操作索引</h3> <p>以索引&quot;user&quot;举例</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#创建索引</span>
PUT user

<span class="token comment">#查询索引</span>
GET user

<span class="token comment">#删除索引</span>
DELETE user

<span class="token comment">#关闭、打开索引</span>
POST user/_close
POST user/_open
</code></pre></div><h3 id="操作映射"><a href="#操作映射" class="header-anchor">#</a> 操作映射</h3> <p>添加映射</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token constant">PUT</span> user<span class="token operator">/</span>_mapping
<span class="token punctuation">{</span>
    <span class="token string">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        	<span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;integer&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建索引并添加映射</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token constant">PUT</span> user
<span class="token punctuation">{</span>
    <span class="token string">&quot;mapping&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
       		#配置映射
    	<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>添加字段：和添加映射一样</p> <h3 id="操作文档"><a href="#操作文档" class="header-anchor">#</a> 操作文档</h3> <p>添加文档，指定id，不指定id会自动生成</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST user/_doc/1
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;张三&quot;</span>,
    <span class="token string">&quot;age&quot;</span>:18,
    <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;湖北武汉&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015113551428.241592ec.png" alt="image-20231015113551428"></p> <p>查询文档</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查询所有文档</span>
GET user/_search
<span class="token comment"># 根据id查询文档</span>
GET user/_doc/1
</code></pre></div><p><img src="/blog/assets/img/image-20231015113646214.2e60de47.png" alt="image-20231015113646214"></p> <p><img src="/blog/assets/img/image-20231015113718603.c74d7e51.png" alt="image-20231015113718603"></p> <p>修改文档</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 全量修改（和添加文档方法一样）</span>
POST user/_doc/1
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;孙悟空&quot;</span>,
    <span class="token string">&quot;age&quot;</span>:900,
    <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;花果山&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 部分修改</span>
POST user/_update/1
<span class="token punctuation">{</span>
    <span class="token string">&quot;doc&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;李四&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015113811839.830e7d91.png" alt="image-20231015113811839"></p> <p><img src="/blog/assets/img/image-20231015113919889.c55b168c.png" alt="image-20231015113919889"></p> <p><img src="/blog/assets/img/image-20231015114047483.47750ea3.png" alt="image-20231015114047483"></p> <p>删除文档</p> <div class="language-shell extra-class"><pre class="language-shell"><code>DELETE user/_doc/1
</code></pre></div><h2 id="java操作es"><a href="#java操作es" class="header-anchor">#</a> Java操作ES</h2> <table><thead><tr><th></th> <th>代理对象Client</th> <th>增</th> <th>删</th> <th>改</th> <th>查</th></tr></thead> <tbody><tr><td>索引操作</td> <td>RestHighLevelClient的indcies()</td> <td>CreateIndexRequest</td> <td>DeleteindexRequest</td> <td>索引没有修改的操作</td> <td>GetIndexRequest</td></tr> <tr><td>文档操作</td> <td>RestHighLevelClient</td> <td>IndexRequest</td> <td>DeleteRequest</td> <td>UpdateRequest、IndexRequest()</td> <td>GetRequest</td></tr> <tr><td>Client发送请求的方法</td> <td></td> <td>create/index</td> <td>delete</td> <td>update</td> <td>get</td></tr></tbody></table> <p>对于索引和文档的操作中，首先要获取一个&quot;代理对象&quot;(用于发送请求)，然后创建一个请求的对象，最后使用代理对象将请求发送出去。</p> <p>对索引的操作首先要通过RestHighLevelClient对象获取IndicesClient对象作为&quot;代理对象&quot;</p> <p>索引操作和文档操作中涉及到的数据发送都通过它们相应的请求设置</p> <h3 id="索引操作"><a href="#索引操作" class="header-anchor">#</a> 索引操作</h3> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>
</code></pre></div><p>获取 操作索引的对象indices</p> <div class="language-java extra-class"><pre class="language-java"><code></code></pre></div><p>构造“创建索引请求”CreateIndexRequest</p> <p>使用操作索引的对象发送请求indices.create()</p> <h4 id="增"><a href="#增" class="header-anchor">#</a> 增</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取 操作索引的对象indices</span>
    <span class="token class-name">IndicesClient</span> indices <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//构造“创建索引请求”CreateIndexRequest</span>
    <span class="token class-name">CreateIndexRequest</span> createIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;test_product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使用操作索引的对象发送请求indices.create()</span>
    indices<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createIndexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>添加索引同时添加映射</p> <div class="language-java extra-class"><pre class="language-java"><code> 	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mappingTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">IndicesClient</span> indices <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CreateIndexRequest</span> createIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;test_mapping4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//错误写法</span>
<span class="token comment">//        String mapping = &quot;\&quot;properties\&quot;:{\n&quot; +</span>
<span class="token comment">//                &quot;        \&quot;name\&quot;:{\n&quot; +</span>
<span class="token comment">//                &quot;          \&quot;type\&quot;:\&quot;text\&quot;,\n&quot; +</span>
<span class="token comment">//                &quot;          \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot; +</span>
<span class="token comment">//                &quot;        },\n&quot; +</span>
<span class="token comment">//                &quot;        \&quot;age\&quot;:{\n&quot; +</span>
<span class="token comment">//                &quot;          \&quot;type\&quot;:\&quot;integer\&quot;\n&quot; +</span>
<span class="token comment">//                &quot;        },\n&quot; +</span>
<span class="token comment">//                &quot;        \&quot;address\&quot;:{\n&quot; +</span>
<span class="token comment">//                &quot;          \&quot;type\&quot;:\&quot;text\&quot;,\n&quot; +</span>
<span class="token comment">//                &quot;          \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot; +</span>
<span class="token comment">//                &quot;        }\n&quot; +</span>
<span class="token comment">//                &quot;    }&quot;;</span>

        <span class="token class-name">String</span> mapping <span class="token operator">=</span> <span class="token string">&quot;{\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    \&quot;properties\&quot;:{\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        \&quot;name\&quot;:{\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;          \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;          \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        },\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        \&quot;age\&quot;:{\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;          \&quot;type\&quot;:\&quot;integer\&quot;\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        },\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        \&quot;address\&quot;:{\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;          \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;          \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;        }\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    }\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>

        createIndexRequest<span class="token punctuation">.</span><span class="token function">mapping</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CreateIndexResponse</span> createIndexResponse <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createIndexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>createIndexResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="删"><a href="#删" class="header-anchor">#</a> 删</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//删除索引</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">IndicesClient</span> indices <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">DeleteIndexRequest</span> deleteIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;test_mapping2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AcknowledgedResponse</span> acknowledgedResponse <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteIndexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;acknowledgedResponse = &quot;</span> <span class="token operator">+</span> acknowledgedResponse<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="查"><a href="#查" class="header-anchor">#</a> 查</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">IndicesClient</span> indices <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">GetIndexRequest</span> getIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;test_mapping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">GetIndexResponse</span> getIndexResponse <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getIndexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MappingMetadata</span><span class="token punctuation">&gt;</span></span> mappings <span class="token operator">=</span> getIndexResponse<span class="token punctuation">.</span><span class="token function">getMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> mappings<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key = &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;value = &quot;</span> <span class="token operator">+</span> mappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="文档操作"><a href="#文档操作" class="header-anchor">#</a> 文档操作</h3> <h4 id="增-2"><a href="#增-2" class="header-anchor">#</a> 增</h4> <p>Map格式的数据可以直接接收，自定义类型对象需要使用JSON格式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;湖北宜昌&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token comment">//document的id</span>
            <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置document的数据，格式设置为json</span>
    <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231014161843158.a9ee0970.png" alt="image-20231014161843158"></p> <h4 id="删-2"><a href="#删-2" class="header-anchor">#</a> 删</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//删除文档</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DeleteRequest</span> deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DeleteResponse</span> deleteResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deleteResponse<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="改"><a href="#改" class="header-anchor">#</a> 改</h4> <p><strong>全量修改</strong></p> <p>和新增的方法一样，存在该文档就修改，不存在就新建</p> <p><strong>增量修改</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//增量修改，只修改文档的一部分</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">UpdateRequest</span> updateRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使用Map存放要修改的数据</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;新疆伊犁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将数据放入updateRequest</span>
    updateRequest<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">UpdateResponse</span> updateResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>updateResponse<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231014164539350.575a16ee.png" alt="image-20231014164539350"></p> <h4 id="查-2"><a href="#查-2" class="header-anchor">#</a> 查</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//查询文档</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetRequest</span> getRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetResponse</span> getResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>getResponse<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="elasticsearch的高级操作"><a href="#elasticsearch的高级操作" class="header-anchor">#</a> ElasticSearch的高级操作</h2> <h3 id="批量操作"><a href="#批量操作" class="header-anchor">#</a> 批量操作</h3> <h4 id="语法格式"><a href="#语法格式" class="header-anchor">#</a> 语法格式</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>POST _bulk
<span class="token punctuation">{</span><span class="token string">&quot;操作名&quot;</span>, <span class="token punctuation">{</span>索引键值对, id键值对<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>携带有数据的，比如添加、删除，将数据写在命令的下一行，</p> <h4 id="批量添加"><a href="#批量添加" class="header-anchor">#</a> 批量添加</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 批量添加</span>
POST _bulk
<span class="token punctuation">{</span><span class="token string">&quot;create&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">18</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;create&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">19</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;create&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
</code></pre></div><p>上面{&quot;name&quot;: &quot;张三&quot;, &quot;age&quot;: 18}这种格式就是要添加的数据</p> <p><img src="/blog/assets/img/image-20231014174031520.05fdf64a.png" alt="image-20231014174031520"></p> <h4 id="批量删除"><a href="#批量删除" class="header-anchor">#</a> 批量删除</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 批量删除</span>
POST _bulk
<span class="token punctuation">{</span><span class="token string">&quot;delete&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;delete&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;delete&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;delete&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231014174147604.1389ac94.png" alt="image-20231014174147604"></p> <h4 id="批量修改"><a href="#批量修改" class="header-anchor">#</a> 批量修改</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>POST _bulk
<span class="token punctuation">{</span><span class="token string">&quot;update&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;doc&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;修改后的张三&quot;</span>, <span class="token string">&quot;age&quot;</span>:28<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;update&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;doc&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;修改后的李四&quot;</span>, <span class="token string">&quot;age&quot;</span>:28<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;update&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;user&quot;</span>,<span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;doc&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;修改后的王五&quot;</span>, <span class="token string">&quot;age&quot;</span>:28<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231014174634764.458dde8b.png" alt="image-20231014174634764"></p> <h3 id="高级查询"><a href="#高级查询" class="header-anchor">#</a> 高级查询</h3> <h4 id="使用restful-api"><a href="#使用restful-api" class="header-anchor">#</a> 使用RESTful API</h4> <h5 id="match-all查询"><a href="#match-all查询" class="header-anchor">#</a> match all查询</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># match_all查询 </span>
<span class="token comment"># from：从查询结果第几条记录开始返回</span>
<span class="token comment"># size：共返回多少条记录</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">500</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="term查询"><a href="#term查询" class="header-anchor">#</a> term查询</h5> <p>官方文档的描述：</p> <p><code>term</code> 查询被用于精确值匹配，这些精确值可能是数字、时间、布尔或者那些 <code>not_analyzed</code> 的字符串：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span>    <span class="token number">26</span>           <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;date&quot;</span><span class="token builtin class-name">:</span>   <span class="token string">&quot;2014-09-01&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;public&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>         <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;tag&quot;</span><span class="token builtin class-name">:</span>    <span class="token string">&quot;full_text&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p><code>term</code> 查询对于<strong>输入的文本</strong>不 <em>分析</em> ，所以它将给定的值进行精确查询。</p> <p><img src="/blog/assets/img/image-20231015130420756.2f4994d2.png" alt="image-20231015130420756"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## term查询</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">18</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015162814965.4932c7e7.png" alt="image-20231015162814965"></p> <h5 id="match查询"><a href="#match查询" class="header-anchor">#</a> match查询</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># match查询</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;修改后的李四&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015134311818.d78c2b5a.png" alt="image-20231015134311818"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># match查询 使用and</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span>:<span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;修改后的李四&quot;</span>,
        <span class="token string">&quot;operator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;and&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015134223083.f60c76f1.png" alt="image-20231015134223083"></p> <h5 id="querystring"><a href="#querystring" class="header-anchor">#</a> querystring</h5> <p>可以识别query中的连接符&quot;OR&quot;/&quot;AND&quot;</p> <p>使用OR的话，只要给定的字段中出现任一关键词，就会匹配成功。</p> <p>使用AND的话，只要在给定所有的字段中能找到所有给定的关键词(用AND连接的关键词)，就会匹配成功。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## querystring查询 使用or</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;额尔古纳 OR 李四&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015135637702.03b7dd7a.png" alt="image-20231015135637702"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## querystring查询 使用and</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;额尔古纳 AND 李四&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015135735497.3bc70dec.png" alt="image-20231015135735497"></p> <h5 id="范围、排序查询"><a href="#范围、排序查询" class="header-anchor">#</a> 范围、排序查询</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">### 范围查询</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,
        <span class="token string">&quot;lte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015140804020.0ff35aaf.png" alt="image-20231015140804020"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">### 范围查询 + 排序</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,
        <span class="token string">&quot;lte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;desc&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015141406697.5c6eb618.png" alt="image-20231015141406697"></p> <h5 id="bool复合查询"><a href="#bool复合查询" class="header-anchor">#</a> bool复合查询</h5> <p>对多个查询条件连接</p> <p>主要分为四种连接方式</p> <ul><li>must：相当于and，条件必须成立</li> <li>must_not：相当于not，条件必须不成立</li> <li>should：相当于or，条件可以成立</li> <li>filter：条件必须成立，性能比must高，不会计算相似度得分score</li></ul> <p>格式</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bool查询格式</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        查询表达式
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>must</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bool查询 must</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">18</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖北&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015145255901.ba582b3a.png" alt="image-20231015145255901"></p> <p>must_not</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bool查询 must_not</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must_not&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖北宜昌&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015145350143.bc100c50.png" alt="image-20231015145350143"></p> <p>should</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bool查询 should 多个条件之间是or关系</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;should&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">18</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖北荆州&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015145536827.e9c2fa58.png" alt="image-20231015145536827"></p> <p>filter</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bool查询 filter</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">18</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖北&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015145640020.f49ed8c1.png" alt="image-20231015145640020"></p> <h5 id="聚合查询"><a href="#聚合查询" class="header-anchor">#</a> 聚合查询</h5> <p>聚合查询分为两种：
指标聚合：类似于MySQL的聚合函数。有max、min、avg、sum等</p> <p>桶聚合：相当于MySQL的group by操作。不要对text类型的字段进行分组，会失败。&quot;操作类型&quot;为terms</p> <p>格式</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;别名&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;聚合操作类型&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;字段名&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>指标聚合</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 指标聚合</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span>:10,
        <span class="token string">&quot;lte&quot;</span>:20
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;max_age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;max&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015151038734.ffdc5c52.png" alt="image-20231015151038734"></p> <p>桶聚合</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 桶聚合</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span>:10,
        <span class="token string">&quot;lte&quot;</span>:20
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;age_bucket&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015151459197.2a07eee0.png" alt="image-20231015151459197"></p> <h5 id="高亮查询"><a href="#高亮查询" class="header-anchor">#</a> 高亮查询</h5> <h4 id="在java中使用查询"><a href="#在java中使用查询" class="header-anchor">#</a> 在Java中使用查询</h4> <h5 id="发送查询请求"><a href="#发送查询请求" class="header-anchor">#</a> 发送查询请求</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
<span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
<span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
<span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
<span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
</code></pre></div><p>怎么设置请求携带的参数：</p> <div class="language-java extra-class"><pre class="language-java"><code>searchSourceBuilder<span class="token punctuation">.</span>参数名<span class="token punctuation">(</span>参数值<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>怎么指定查询方式：</p> <div class="language-java extra-class"><pre class="language-java"><code>searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span>查询方式名<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="接收响应的查询结果"><a href="#接收响应的查询结果" class="header-anchor">#</a> 接收响应的查询结果</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 1. 获取查询结果hits</span>
<span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
<span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
</code></pre></div><h5 id="match-all查询-2"><a href="#match-all查询-2" class="header-anchor">#</a> match all查询</h5> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchAllTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
        <span class="token class-name">MatchAllQueryBuilder</span> matchAllQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>matchAllQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理结果</span>
        <span class="token comment">// 1. 获取查询结果hits</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>from: 0, size: 3查询结果</p> <p><img src="/blog/assets/img/image-20231015161311078.7fc93a3d.png" alt="image-20231015161311078"></p> <p>from: 0, size: 30查询结果</p> <p><img src="/blog/assets/img/image-20231015161411083.03ae731b.png" alt="image-20231015161411083"></p> <h5 id="term查询-2"><a href="#term查询-2" class="header-anchor">#</a> term查询</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">termTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TermQueryBuilder</span> termQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>termQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理响应结果</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> value <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015163509556.79270843.png" alt="image-20231015163509556"></p> <h5 id="match查询-2"><a href="#match查询-2" class="header-anchor">#</a> match查询</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
<span class="token comment">//        MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(&quot;name&quot;, &quot;修改后的李四&quot;);</span>
<span class="token comment">//        matchQueryBuilder.operator(Operator.AND);</span>
        <span class="token comment">// 3. 改为链式编程格式</span>
        <span class="token class-name">MatchQueryBuilder</span> matchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;修改后的李四&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">Operator</span><span class="token punctuation">.</span><span class="token constant">AND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>matchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理结果</span>
        <span class="token comment">// 1. 获取查询结果hits</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="image-20231015164613350"></p> <h5 id="querystring-2"><a href="#querystring-2" class="header-anchor">#</a> querystring</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryStringTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
        <span class="token class-name">QueryStringQueryBuilder</span> queryStringQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">queryStringQuery</span><span class="token punctuation">(</span><span class="token string">&quot;额尔古纳 OR 李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryStringQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理结果</span>
        <span class="token comment">// 1. 获取查询结果hits</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015165128912.725faf50.png" alt="image-20231015165128912"></p> <h5 id="范围、排序查询-2"><a href="#范围、排序查询-2" class="header-anchor">#</a> 范围、排序查询</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rangAndSortTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//发送请求</span>
    <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
    <span class="token class-name">RangeQueryBuilder</span> rangeQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>rangeQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置排序方式，按年龄降序排序</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//处理结果</span>
    <span class="token comment">// 1. 获取查询结果hits</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> source <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015170901015.fde82445.png" alt="image-20231015170901015"></p> <h5 id="bool复合查询-2"><a href="#bool复合查询-2" class="header-anchor">#</a> bool复合查询</h5> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">boolTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询条件1</span>
        <span class="token class-name">TermQueryBuilder</span> termQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询条件2</span>
        <span class="token class-name">MatchQueryBuilder</span> matchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;湖北&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询条件3</span>
        <span class="token class-name">MatchQueryBuilder</span> matchQueryBuilder2 <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        List&lt;QueryBuilder&gt; mustList = boolQueryBuilder.must();</span>
<span class="token comment">//        mustList.add(termQueryBuilder);</span>
<span class="token comment">//        mustList.add(matchQueryBuilder);</span>

        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>termQueryBuilder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>matchQueryBuilder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>matchQueryBuilder2<span class="token punctuation">)</span><span class="token punctuation">;</span>


        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//处理结果</span>
        <span class="token comment">// 1. 获取查询结果hits</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// 2. 从查询结果hits中获取所有记录集合hits</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 遍历第二级hits中，遍历的元素中_source字段才是真正的数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231015172433453.494acade.png" alt="image-20231015172433453"></p> <h5 id="聚合查询-2"><a href="#聚合查询-2" class="header-anchor">#</a> 聚合查询</h5> <p><strong>指标聚合</strong></p> <p>核心步骤</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//构造聚合函数</span>
<span class="token class-name">MaxAggregationBuilder</span> maxAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">&quot;max_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>maxAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>详细步骤</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aggsTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//发送请求</span>
    <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
    <span class="token class-name">RangeQueryBuilder</span> rangeQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>rangeQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//构造聚合函数</span>
    <span class="token class-name">MaxAggregationBuilder</span> maxAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">&quot;max_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>maxAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置排序方式，按年龄降序排序</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Max</span> max <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;max_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> maxAge <span class="token operator">=</span> max<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;maxAge = &quot;</span> <span class="token operator">+</span> maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="image-20231015174449297"></p> <p><strong>桶聚合</strong></p> <p>核心步骤</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//构造聚合函数</span>
<span class="token class-name">TermsAggregationBuilder</span> termsAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;age_bucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>termsAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>详细步骤</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bucketAggsTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//发送请求</span>
    <span class="token comment">// 1. 创建SearchRequest对象作为请求</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 创建SearchSourceBuilder用于携带查询参数</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 使用QueryBuilders.查询方式名Query()创建查询方式对象，用于携带相应的查询参数</span>
    <span class="token class-name">RangeQueryBuilder</span> rangeQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>rangeQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//构造聚合函数</span>
    <span class="token class-name">TermsAggregationBuilder</span> termsAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;age_bucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>termsAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置排序方式，按年龄降序排序</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 将参数放入请求：searchRequest.source(searchSourceBuilder)</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 使用RestHighLevelClient对象的search方法发送SearchRequest请求</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Terms</span> terms <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;age_bucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> terms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> docCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="image-20231015175816867"></p> <h5 id="高亮查询-2"><a href="#高亮查询-2" class="header-anchor">#</a> 高亮查询</h5> <p>将查询到的文档的指定的字段中匹配到的关键词添加指定的html标签使它在前端高亮显示。</p> <p>应用场景：前端搜索后，在返回的数据中将匹配到的关键词高亮显示。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">### 高亮查询</span>
GET user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span>, 
  <span class="token string">&quot;highlight&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;pre_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&lt;font color='red'&gt;&quot;</span>, 
        <span class="token string">&quot;post_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&lt;/font&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/assets/img/image-20231016210013727.6c6991d6.png" alt="image-20231016210013727"></p> <h2 id="elasticsearch集群"><a href="#elasticsearch集群" class="header-anchor">#</a> ElasticSearch集群</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p><strong>结点(Node)</strong>：</p> <p>Master Node: 负责创建删除索引、以及给节点分配分片等集群管理的工作。</p> <p>Data Node: 负责存储文档、以及对文档数据的增删改查操作。</p> <p>Coordinating Node: 负责接收客户端请求，并将请求分发到各个相关的结点，并最终收集各节点返回的结果，整合成一个统一的节点，返回给客户端。</p> <p><strong>分片</strong>：ES中的数据都是存储在分片中，一个索引的一个分片只存储该索引的一部分数据，一个索引中的文档数据被存储在其所属的若干个分片中。</p> <p>主分片：</p> <p>副本分片：</p> <p><img src="/blog/assets/img/image-20231016223814967.de4cdec7.png" alt="image-20231016223814967"></p> <h3 id="文档数据在es集群中的存储和搜索"><a href="#文档数据在es集群中的存储和搜索" class="header-anchor">#</a> 文档数据在ES集群中的存储和搜索</h3> <h4 id="文档的存储"><a href="#文档的存储" class="header-anchor">#</a> 文档的存储</h4> <p>① ES首先根据文档id的散列值，选择一个主分片，并将该分片发送到该主分片保存。</p> <p>② 将该分片发送到其主分片对应的所有副本分片进行保存，(这样使得副本分片和主分片之间保持数据同步)。</p> <p>数据同步使得副本分片可以服务于搜索请求，并在原有主分片无法访问时升级为主分片</p> <p><img src="/blog/assets/img/image-20231016225005121.c4bdf3a4.png" alt="image-20231016225005121"></p> <p>文档数据存储举例：</p> <p>假如经过计算，该文档对应的主分片为a索引的主分片0，则先将该文档数据存入主分片0，然后将数据存储到两个副本分片0</p> <h4 id="文档数据的搜索"><a href="#文档数据的搜索" class="header-anchor">#</a> 文档数据的搜索</h4> <p>主要采用轮训策略</p> <p>① 搜索请求被一个ES Node接收，并将请求转发到一组包含所有数据的索引分片组合</p> <p>② 在选择可用的分片时，使用轮训算法选择出一个分片组合，将请求转发给这个组合中的分片。</p> <p>③ 从接收到请求的分片收集搜索到的结果，将其聚集到单一的回复，然后将回复返回给客户端。</p> <p><img src="/blog/assets/img/image-20231016222539627.fcf68482.png" alt="image-20231016222539627"></p> <h3 id="脑裂问题"><a href="#脑裂问题" class="header-anchor">#</a> 脑裂问题</h3> <h2 id="elasticsearch应用"><a href="#elasticsearch应用" class="header-anchor">#</a> ElasticSearch应用</h2> <p>以商品搜索为例</p> <h3 id="添加、删除文档"><a href="#添加、删除文档" class="header-anchor">#</a> 添加、删除文档</h3> <p>① 在商品上架的时候将商品信息添加到ES</p> <p>② 在商品下架的时候将商品从ES中删除</p> <p>详细步骤</p> <p>① 在商品上架的时候将商品信息添加到ES</p> <p>​	a. 创建一个document对应的类型对象，然后查询其相应的属性对应的参数值，然后给这些属性赋值(查询属性使用Product对外提供的API接口，属性主要有商品的基本信息、类目信息、品牌信息、平台属性)。</p> <p>​	b. 调用Repository的save方法将商品信息添加到ES。</p> <p>② 在商品下架的时候将商品从ES中删除</p> <p>​	调用Repository的deleteById方法删除。</p> <h3 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h3> <p>① 构建查询DSL(NativeSearchQueryBuilder)，并调用其build方法创建NativeSearchQuery</p> <p>② 调用RestTemplate对象的search方法进行查询</p> <p>③ 解析查询结果</p> <p>详细步骤：</p> <p>① 构建查询DSL(NativeSearchQueryBuilder)，并调用其build方法创建NativeSearchQuery</p> <p>​	(1) 构建查询器NativeSearchQueryBuilder</p> <p>​	(2) 构建boolQueryBuilder，用于组合多个查询</p> <p>​	(3) 分别构建关键字查询、品牌查询、类目查询、平台属性查询，并放入boolQueryBuilder</p> <p>​	(4) 设置整个复合查询，将boolQueryBuilder添加到NativeSearchQueryBuilder(使用其withQuery方法)</p> <p>​	(5) 构建分页查询</p> <p>​	(6) 构建排序查询</p> <p>​	(7) 构建高亮查询</p> <p>​	(8) 构建聚合查询</p> <p>​	(9) 指定查询结果中的字段</p> <p>② 调用RestTemplate对象的search方法进行查询</p> <p>③ 解析查询结果</p> <p>​	(1) 解析商品信息goodsList</p> <p>​	(2) 解析商标trademarkList</p> <p>​	(3) 解析平台属性attrsList</p> <p>​	(4) 解析分页数据</p> <h3 id="构建聚合查询"><a href="#构建聚合查询" class="header-anchor">#</a> 构建聚合查询</h3> <p>品牌聚合</p> <p>① 构建外层品牌id聚合(使用AggregationBuilders)</p> <p>② 构建内层品牌名称聚合(外层聚合使用subAggregation方法将其添加)</p> <p>③ 构建内层品牌LogoUrl聚合(外层聚合使用subAggregation方法将其添加)</p> <p>平台属性聚合</p> <p>① 创建外层nest聚合</p> <p>② 构建外层平台属性id聚合(使用AggregationBuilders)</p> <p>③ 构建内层属性名称聚合(外层聚合使用subAggregation方法将其添加)</p> <p>④ 构建内层属性值聚合(外层聚合使用subAggregation方法将其添加)</p> <h3 id="incrhotscore"><a href="#incrhotscore" class="header-anchor">#</a> incrHotScore</h3> <p>① 在redis中用一个ScoreSortedSet记录商品的得分，在调用increHotScore方法的时候，让对应的商品score自增(使用socreSortedSet的addScore方法)</p> <p>② 在ElasticSearch中修改对应商品的score，获取对应商品的document，然后获取对应的java对象，将该对象的score加1，然后保存到ElasticSearch</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/skills/JavaEE&amp;Spring/设计模式.html" class="prev">
        设计模式
      </a></span> <span class="next"><a href="/blog/skills/微服务/Gateway.html">
        Gateway
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.e95f8842.js" defer></script><script src="/blog/assets/js/3.08356745.js" defer></script><script src="/blog/assets/js/2.9988781b.js" defer></script>
  </body>
</html>
