<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>秒杀 | 琅玕的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="个人编程技术分享">
    
    <link rel="preload" href="/blog/assets/css/0.styles.671fbdd0.css" as="style"><link rel="preload" href="/blog/assets/js/app.e95f8842.js" as="script"><link rel="preload" href="/blog/assets/js/3.08356745.js" as="script"><link rel="preload" href="/blog/assets/js/27.03389df0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.acf34bf9.js"><link rel="prefetch" href="/blog/assets/js/11.fef1fa27.js"><link rel="prefetch" href="/blog/assets/js/12.c774ebf1.js"><link rel="prefetch" href="/blog/assets/js/13.bf6af2da.js"><link rel="prefetch" href="/blog/assets/js/14.7b60b543.js"><link rel="prefetch" href="/blog/assets/js/15.5515032c.js"><link rel="prefetch" href="/blog/assets/js/16.3c0cd04c.js"><link rel="prefetch" href="/blog/assets/js/17.80206c1e.js"><link rel="prefetch" href="/blog/assets/js/18.e5e2c85c.js"><link rel="prefetch" href="/blog/assets/js/19.2f69b079.js"><link rel="prefetch" href="/blog/assets/js/2.9988781b.js"><link rel="prefetch" href="/blog/assets/js/20.7a923a3b.js"><link rel="prefetch" href="/blog/assets/js/21.d81d0001.js"><link rel="prefetch" href="/blog/assets/js/22.2fe5ab39.js"><link rel="prefetch" href="/blog/assets/js/23.99bc8ff5.js"><link rel="prefetch" href="/blog/assets/js/24.1fcf63f7.js"><link rel="prefetch" href="/blog/assets/js/25.a5536fa6.js"><link rel="prefetch" href="/blog/assets/js/26.e2fb222c.js"><link rel="prefetch" href="/blog/assets/js/28.4b72525f.js"><link rel="prefetch" href="/blog/assets/js/29.03a090ad.js"><link rel="prefetch" href="/blog/assets/js/30.87f31b47.js"><link rel="prefetch" href="/blog/assets/js/31.c639ea6f.js"><link rel="prefetch" href="/blog/assets/js/32.795ca246.js"><link rel="prefetch" href="/blog/assets/js/33.647699a4.js"><link rel="prefetch" href="/blog/assets/js/34.2909ac9c.js"><link rel="prefetch" href="/blog/assets/js/35.b5d4b577.js"><link rel="prefetch" href="/blog/assets/js/36.474a6bcb.js"><link rel="prefetch" href="/blog/assets/js/37.4590b450.js"><link rel="prefetch" href="/blog/assets/js/38.1cfbe263.js"><link rel="prefetch" href="/blog/assets/js/39.4c159456.js"><link rel="prefetch" href="/blog/assets/js/4.1c4b8134.js"><link rel="prefetch" href="/blog/assets/js/40.c52cb9af.js"><link rel="prefetch" href="/blog/assets/js/41.f77d6a1f.js"><link rel="prefetch" href="/blog/assets/js/42.c45631ae.js"><link rel="prefetch" href="/blog/assets/js/43.44644811.js"><link rel="prefetch" href="/blog/assets/js/44.c40d24aa.js"><link rel="prefetch" href="/blog/assets/js/45.0c1b86d7.js"><link rel="prefetch" href="/blog/assets/js/46.85dd5346.js"><link rel="prefetch" href="/blog/assets/js/47.a52d8379.js"><link rel="prefetch" href="/blog/assets/js/48.dfaedde6.js"><link rel="prefetch" href="/blog/assets/js/49.604893e5.js"><link rel="prefetch" href="/blog/assets/js/5.b41d7dd5.js"><link rel="prefetch" href="/blog/assets/js/50.228c7e1a.js"><link rel="prefetch" href="/blog/assets/js/51.7a95ac4e.js"><link rel="prefetch" href="/blog/assets/js/52.79ff7d2e.js"><link rel="prefetch" href="/blog/assets/js/53.7aeffa50.js"><link rel="prefetch" href="/blog/assets/js/54.c7097067.js"><link rel="prefetch" href="/blog/assets/js/6.31dc016b.js"><link rel="prefetch" href="/blog/assets/js/7.96c397d1.js"><link rel="prefetch" href="/blog/assets/js/8.e97d6841.js"><link rel="prefetch" href="/blog/assets/js/9.66ed6f07.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.671fbdd0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">琅玕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  资源分享
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/share/" class="nav-link">
  资源分享
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/skills/IoT" class="sidebar-heading clickable"><span>IoT</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/IoT/基于NodeMcu的智慧生态农业系统设计.html" class="sidebar-link">基于NodeMcu的智慧生态农业系统设计</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/JavaSE" class="sidebar-heading clickable"><span>JavaSE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/JavaSE/File类和IO流.html" class="sidebar-link">File类和IO流</a></li><li><a href="/blog/skills/JavaSE/Java基础手写笔记.html" class="sidebar-link">/skills/JavaSE/Java基础手写笔记.html</a></li><li><a href="/blog/skills/JavaSE/Java常用API.html" class="sidebar-link">Java常用API</a></li><li><a href="/blog/skills/JavaSE/Thread.html" class="sidebar-link">Thread</a></li><li><a href="/blog/skills/JavaSE/内部类.html" class="sidebar-link">内部类</a></li><li><a href="/blog/skills/JavaSE/反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/DSDB" class="sidebar-heading clickable"><span>DSDB</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/DSDB/Collection.html" class="sidebar-link">Java的集合类</a></li><li><a href="/blog/skills/DSDB/HTTP&amp;Tomcat.html" class="sidebar-link">HTTP&amp;Tomcat</a></li><li><a href="/blog/skills/DSDB/JDBC.html" class="sidebar-link">JDBC</a></li><li><a href="/blog/skills/DSDB/Map.html" class="sidebar-link">Map</a></li><li><a href="/blog/skills/DSDB/Maven.html" class="sidebar-link">Maven</a></li><li><a href="/blog/skills/DSDB/Mybatis.html" class="sidebar-link">Mybatis</a></li><li><a href="/blog/skills/DSDB/SQL.html" class="sidebar-link">SQL</a></li><li><a href="/blog/skills/DSDB/Stream.html" class="sidebar-link">Stream</a></li><li><a href="/blog/skills/DSDB/前端.html" class="sidebar-link">前端</a></li><li><a href="/blog/skills/DSDB/数据库索引.html" class="sidebar-link">数据库索引</a></li><li><a href="/blog/skills/DSDB/连接池.html" class="sidebar-link">/skills/DSDB/连接池.html</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/JavaEE&amp;Spring" class="sidebar-heading clickable"><span>JavaEE&amp;Spring</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/JavaEE&amp;Spring/MyBatis-Spring.html" class="sidebar-link">MyBatis - Spring、Spring事务</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/Request&amp;Response.html" class="sidebar-link">Request &amp; Response</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/Servlet.html" class="sidebar-link">Servlet</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringAOP.html" class="sidebar-link">Spring AOP</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringBoot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringIOC.html" class="sidebar-link">Spring IOC</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/SpringMVC.html" class="sidebar-link">Spring MVC</a></li><li><a href="/blog/skills/JavaEE&amp;Spring/设计模式.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/微服务" class="sidebar-heading clickable open"><span>微服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/微服务/ElasticSearch.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/blog/skills/微服务/Gateway.html" class="sidebar-link">Gateway</a></li><li><a href="/blog/skills/微服务/MapStruct.html" class="sidebar-link">MapStruct</a></li><li><a href="/blog/skills/微服务/Mybatis-Plus.html" class="sidebar-link">Mybatis-Plus</a></li><li><a href="/blog/skills/微服务/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/blog/skills/微服务/Redis.html" class="sidebar-link">Redis</a></li><li><a href="/blog/skills/微服务/Redis在Java项目中的使用.html" class="sidebar-link">Redis在Java项目中的使用</a></li><li><a href="/blog/skills/微服务/RocketMQ.html" class="sidebar-link">RocketMQ</a></li><li><a href="/blog/skills/微服务/SpringCloud.html" class="sidebar-link">SpringCloud</a></li><li><a href="/blog/skills/微服务/微服务.html" class="sidebar-link">微服务</a></li><li><a href="/blog/skills/微服务/微服务架构和单体架构.html" class="sidebar-link">微服务架构和单体架构</a></li><li><a href="/blog/skills/微服务/秒杀.html" class="active sidebar-link">秒杀</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#思路" class="sidebar-link">思路</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#缓存预热" class="sidebar-link">缓存预热</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#使用状态位控制访问请求" class="sidebar-link">使用状态位控制访问请求</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#秒杀排队实现方式" class="sidebar-link">秒杀排队实现方式</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#库存超卖问题" class="sidebar-link">库存超卖问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#实现" class="sidebar-link">实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#缓存预热-2" class="sidebar-link">缓存预热</a></li><li class="sidebar-sub-header"><a href="/blog/skills/微服务/秒杀.html#秒杀下单排队" class="sidebar-link">秒杀下单排队</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/skills/面试" class="sidebar-heading clickable"><span>面试</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/面试/面经.html" class="sidebar-link">面经</a></li><li><a href="/blog/skills/面试/面试准备.html" class="sidebar-link">面试准备</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="秒杀"><a href="#秒杀" class="header-anchor">#</a> 秒杀</h1> <h2 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h2> <h3 id="缓存预热"><a href="#缓存预热" class="header-anchor">#</a> 缓存预热</h3> <p>使用Spring定时任务每天凌晨两点将当天的秒杀活动商品数据加载到Redis中。</p> <blockquote><p>缓存预热就是系统启动前，提前将相关数据直接加载到缓存系统。避免在用户请求的时候，先查询数据库，然后再将数据缓存。</p></blockquote> <p>如果不考虑缓存，那么每次都需要访问直接数据库。而秒杀列表页和秒杀商品详情页的点击量一般会比较大，那势必会给数据库带来很大的压力，所以在此考虑使用缓存预热的方案。</p> <h3 id="使用状态位控制访问请求"><a href="#使用状态位控制访问请求" class="header-anchor">#</a> 使用状态位控制访问请求</h3> <p>我们在内存中保持一个状态位，当抢购开始时状态为1，可以抢购，当库存为0时状态位为0，不能抢购。状态位的好处是它是在内存中判断，压力比较小，可以阻止很多不必要的请求。</p> <h3 id="秒杀排队实现方式"><a href="#秒杀排队实现方式" class="header-anchor">#</a> 秒杀排队实现方式</h3> <p>用户提交秒杀请求，将秒杀商品与用户id关联发送给消息队列，然后返回。通过消息队列排队抢购秒杀资格。秒杀页面通过轮询接口查看是否秒杀成功。</p> <p>我们秒杀只是为了获取一个秒杀资格，获取秒杀资格后就可以到下单页面下订单，后续业务和正常订单一样。</p> <h3 id="库存超卖问题"><a href="#库存超卖问题" class="header-anchor">#</a> 库存超卖问题</h3> <p>使用Redis队列存储商品库存，利用Redis队列的原子性，保证库存不超卖。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <table><thead><tr><th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>缓存预热</td> <td>使用Spring定时任务每天凌晨两点将当天的秒杀活动商品数据加载到Redis中。</td> <td></td></tr> <tr><td>秒杀商品列表</td> <td>返回所有的秒杀商品</td> <td></td></tr> <tr><td>秒杀商品详情</td> <td>返回指定的秒杀商品</td> <td></td></tr> <tr><td>秒杀下单排队</td> <td>获取下单码、秒杀下单排队</td> <td><strong>下单码</strong>主要目的是秒杀下单的时候校验用户请求，防止非法请求参与秒杀。</td></tr> <tr><td>秒杀下单消费</td> <td>1. 判断状态位(看是否有库存)。2.标记用户下单(使用redis.setnx(userId))。3.获取库存队列。4.弹出库存。5.生成订单记录，存入Redis。</td> <td></td></tr> <tr><td>检查秒杀下单结果</td> <td>1.  判断用户是否已经下过单。 2. 判断Redis中是否已经存在用户的订单，如果存在，说明抢单成功，返回秒杀成功状态码。3. 如果不满足1和2中的条件，就执行后面的。4. 判断库存标志位，看是否有库存，没有库存据返回已售罄标志位。5. 以上都不满足，就返回正在排队中。</td> <td></td></tr> <tr><td>秒杀下单商品确认页</td> <td>当抢购成功之后，前端页面显示抢购成功，去下单。和订单服务的下单商品确认页逻辑类似。1. 从Redis中获取下单记录OrderRecord，然后获取秒杀详情SeckillGoods。 2. 获取用户地址 3. 构建OrderTradeDTO(下单确认页信息)</td> <td></td></tr> <tr><td>秒杀下单生成(提交)订单</td> <td>1. 获取用户id。 2. 判断是否已经提交过订单，如果已经提交过订单，就返回相应的失败状态码。3. 远程调用订单服务，生成秒杀订单。4. 删除Redis中的下单信息。5. 在Redis中增加秒杀提交标记，表示用户已经提交了订单。</td> <td></td></tr> <tr><td>定时任务清除缓存</td> <td>每天在固定时间清除当天的秒杀数据</td> <td></td></tr></tbody></table> <h3 id="缓存预热-2"><a href="#缓存预热-2" class="header-anchor">#</a> 缓存预热</h3> <p>在凌晨将当天的所有秒杀商品从数据库中放入redis缓存</p> <p>① 从数据库中查询状态为审核通过、开始时间在当天、库存大于的商品。</p> <p>② 在redis中使用一个hash存储当天的商品，遍历当天的每个商品，将他们放入redis的hash中。hash的field为商品id，value为商品信息。</p> <p>③ 使用一个队列表示每个商品的库存，添加一个元素(商品id)代表新增一个库存，移除一个元素就代表减少一个库存。</p> <p>④ 初始化库存标志位为&quot;1&quot;，表示有库存。</p> <h3 id="秒杀下单排队"><a href="#秒杀下单排队" class="header-anchor">#</a> 秒杀下单排队</h3> <h4 id="获取下单码"><a href="#获取下单码" class="header-anchor">#</a> 获取下单码</h4> <p>① 在redis中查询该商品是否存在，如果不存在就直接返回&quot;不合法&quot;的状态码</p> <p>② 如果该商品存在，就判断当前时间是否还在活动时间内，如果在活动时间内，就返回由userId + skuId使用MD5编码后的字符串作为下单码，否则就返回失败。</p> <h4 id="秒杀下单排队-携带下单码发送下单请求"><a href="#秒杀下单排队-携带下单码发送下单请求" class="header-anchor">#</a> 秒杀下单排队（携带下单码发送下单请求）</h4> <p>① 判断秒杀商品库存状态标志位。如果该标志位为null，就返回secKill_illegal的状态码；如果该标志位为&quot;0&quot;，就返回&quot;skill_finish&quot;的状态码。</p> <p>② 能够执行到这一步就说明还有库存，验证秒杀下单码是否正确。下单码不正确就返回&quot;skill_illegal&quot;的状态码；下单码正确，就创建一个UserRecord对象记录skuId和userId，然后将这个对象作为rocketMQ消息发送。</p> <h4 id="秒杀下单消息消费"><a href="#秒杀下单消息消费" class="header-anchor">#</a> 秒杀下单消息消费</h4> <p><img src="/blog/assets/img/image-20231109155254881.6960814b.png" alt="image-20231109155254881"></p> <p>① 在消息监听器中将获取到的消息转换成UserRecord对象，然后调用service层方法，将UserRecord中userId和skuId传入这个方法。</p> <p>② 在service层方法中，使用库存标志位判断该商品是否已经售罄，售罄就返回。</p> <p>③ 使用redis的string的setnx方法添加记录来判断每个用户是否是第一次参加一场秒杀活动，如果成功添加记录，就说明之前没有添加过，没有参加过该秒杀活动；如果添加失败，就反之。</p> <p>④ 如果是第一次参加，就通过该商品对应的队列出队来扣减库存，出队元素为null，就说明没有库存了；出队元素不为null，就说明用户获取了秒杀资格。</p> <p>⑤ 从redis中获取该秒杀商品，创建一个OrderRecord对象，根据该秒杀商品给它相关属性赋值，然后放入redis(在redis中使用hash存储OrderRecord，field为userId，value为OrderRecord)</p> <h5 id="更新库存"><a href="#更新库存" class="header-anchor">#</a> 更新库存</h5> <p>① 获取、使用redis的锁</p> <p>② 从redis中获取真实的库存，从redis中获取该商品，修改它的库存后再放回redis。</p> <p>③ 将该商品信息更新到数据库。</p> <h4 id="返回秒杀下单结果"><a href="#返回秒杀下单结果" class="header-anchor">#</a> 返回秒杀下单结果</h4> <p>① 判断秒杀下单消息是否已经被消费</p> <p>​	使用redis中下单排队标记记录是否已经消费过了。</p> <p>② 如果消息已经消费了，</p> <p>​	(1) 通过获取redis中的订单信息，看其中有没有该用户的订单信息，有的话就说明秒杀成功，返回秒杀成功状态码。</p> <p>​	(2) 从redis中的已提交秒杀订单，看里面是否有该用户的订单，有的话就说明下单成功，返回秒杀成功状态码。</p> <p>③ 如果消息没有消费</p> <p>有两种可能：(1) 库存为0，没有发送排队消息。(2)消息还在排队。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/skills/微服务/微服务架构和单体架构.html" class="prev">
        微服务架构和单体架构
      </a></span> <span class="next"><a href="/blog/skills/面试/面经.html">
        面经
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.e95f8842.js" defer></script><script src="/blog/assets/js/3.08356745.js" defer></script><script src="/blog/assets/js/27.03389df0.js" defer></script>
  </body>
</html>
